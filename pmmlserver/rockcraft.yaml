# Based on https://github.com/kserve/kserve/blob/master/python/pmml.Dockerfile
name: pmml-server
summary: Pmml server for Kserve deployments
description: "Kserve Pmml server"
version: "v0.11.0_22.04_1"
license: Apache-2.0
base: ubuntu:22.04
build-base: ubuntu:22.04
platforms:
    amd64:
run-user: _daemon_
services:
  pmml-server:
    override: replace
    summary: "Pmml server service"
    startup: enabled
    command: python3 -m pmmlserver
    environment:
      HOME: /home/kserve
      PATH: /home/kserve/prod_venv/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      PYTHONPATH: /home/kserve/prod_venv/lib/python3.9/site-packages/
      SHELL: /bin/bash
    working-dir: /home/kserve/pmmlserver

package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
    priority: always

parts:
  security-team-requirement:
    plugin: nil
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/rocks
      (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && \
      dpkg-query -f '${db:Status-Abbrev},${binary:Package},${Version},${source:Package},${Source:Version}\n' -W) \
      > ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query

  python:
    plugin: python
    source: https://github.com/kserve/kserve.git
    source-subdir: python
    source-tag: v0.11.0
    build-environment:
    - HOME: "/home/kserve"
    build-packages:
    - openjdk-11-jdk
    stage-packages:
    - python3.9-venv
    overlay-packages:
    - openjdk-11-jdk
    override-build: |
      mkdir -p "${HOME}"
      cd python 
      python3.9 -m venv /opt/poetry &&  /opt/poetry/bin/pip install poetry==1.4.0
      export PATH="$PATH:/opt/poetry/bin"
      export VIRTUAL_ENV=/prod_venv
      python3.9 -m venv /prod_venv
      export PATH="/prod_venv/bin:$PATH"

      mkdir kserve_temp 
      ls -la
      cp kserve/poetry.lock kserve_temp
      cp kserve/pyproject.toml kserve_temp
      (cd kserve_temp && poetry install --no-root --no-interaction --no-cache)
      cp -R kserve/* kserve_temp
      (cd kserve_temp && poetry install --no-interaction --no-cache)

      mkdir pmmlserver_temp 
      cp pmmlserver/poetry.lock pmmlserver_temp
      cp pmmlserver/pyproject.toml pmmlserver_temp
      (cd pmmlserver_temp && poetry install --no-root --no-interaction --no-cache)
      cp -R pmmlserver/* pmmlserver_temp
      (cd pmmlserver_temp && poetry install --no-interaction --no-cache)

      mkdir -p ${CRAFT_PART_INSTALL}${HOME}
      mkdir -p ${CRAFT_PART_INSTALL}/etc
      mkdir -p ${CRAFT_PART_INSTALL}${HOME}/pmmlserver

      ln -s python3.9 "${CRAFT_PART_INSTALL}"/usr/bin/python3

      echo "python3 -m venv /home/kserve/prod_venv" >> "${HOME}/.bashrc"
      echo "python3 -m venv /home/kserve/prod_venv" >> "${CRAFT_PART_INSTALL}/etc/profile"

      cp -r kserve_temp/* $CRAFT_PART_INSTALL${HOME}/pmmlserver
      cp -r pmmlserver_temp/* $CRAFT_PART_INSTALL${HOME}/pmmlserver
      cp -r /prod_venv $CRAFT_PART_INSTALL${HOME}
      craftctl default

  # not-root user for this ROCK should be 'kserve'
  non-root-user:
    plugin: nil
    after: [python]
    overlay-script: |
      # Create a user in the $CRAFT_OVERLAY chroot
      useradd -R $CRAFT_OVERLAY -M -s /bin/bash -N -u 1001 kserve
    override-prime: |
      craftctl default
      chown -R 584792:users /home/kserve
  
  third-party:
    plugin: nil
    after: [python]
    source: https://github.com/kserve/kserve.git
    source-subdir: python
    source-tag: v0.11.0
    build-environment:
    - HOME: "/home/kserve"
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}${HOME}/third_party
      cp -r third_party/* ${CRAFT_PART_INSTALL}${HOME}/third_party

