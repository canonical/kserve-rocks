# Based on the following Dockerfiles:
# https://github.com/pytorch/serve/blob/v0.9.0/docker/Dockerfile
# https://github.com/pytorch/serve/blob/v0.9.0/kubernetes/kserve/Dockerfile
#
# See ../CONTRIBUTING.md for more details about the patterns used in this rock.
# This rock is implemented with some atypical patterns due to the native of the upstream
name: torchserve-kfs
summary: TorchServe is a flexible and easy to use tool for serving and scaling PyTorch models in production.
description: "TorchServe"
version: "0.9.0"
license: Apache-2.0
base: ubuntu@22.04
platforms:
    amd64:
run-user: _daemon_
services:
  torchserve:
    override: replace
    summary: "TorchServe service"
    startup: enabled
    command: "/usr/local/bin/dockerd-entrypoint.sh serve [ ]"
    working-dir: /home/model-server
    user: model-server
    environment:
      TEMP: "/home/model-server/tmp"
      PATH: "/home/venv/bin:$PATH"
entrypoint-service: torchserve

package-repositories:
  - type: apt
    ppa: deadsnakes/ppa
    priority: always

parts:
  security-team-requirement:
    plugin: nil
    override-build: |
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/rocks
      (echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && \
      dpkg-query --root=${CRAFT_PROJECT_DIR}/../bundles/ubuntu-22.04/rootfs/ -f '${db:Status-Abbrev},${binary:Package},${Version},${source:Package},${Source:Version}\n' -W) \
      > ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query

  torchserve-kfs:
    plugin: nil
    source: https://github.com/pytorch/serve
    source-type: git
    source-tag: v0.9.0
    stage-packages:
      - python3.9 
      - python3.9-dev 
      - python3.9-venv
      - openjdk-17-jdk
      - python3-distutils      
    build-packages:
      - ca-certificates
      - git
      - curl
      - software-properties-common
      - build-essential
      - g++ 
      - python3-distutils
      - python3.9 
      - python3.9-dev 
      - python3.9-venv
      - openjdk-17-jdk      
    build-environment:
      - PYTHON_VERSION: "3.9"
      - PYTHONUNBUFFERED: "TRUE"
      - USE_CUDA: "1"
      - CUDA_VERSION: "cu121"
    override-build: |
      set -xe
      
      mkdir -p ${CRAFT_PART_INSTALL}/usr/local/bin/
      cp -r ${CRAFT_PART_SRC}/docker/dockerd-entrypoint.sh ${CRAFT_PART_INSTALL}/usr/local/bin/dockerd-entrypoint.sh
      chmod +x ${CRAFT_PART_INSTALL}/usr/local/bin/dockerd-entrypoint.sh

      mkdir -p ${CRAFT_PART_INSTALL}/home/model-server/tmp
      mkdir ${CRAFT_PART_INSTALL}/home/model-server/model-store
      mkdir ${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper      

      cp -r ${CRAFT_PART_SRC}/docker/config.properties ${CRAFT_PART_INSTALL}/home/model-server/config.properties
      cp ${CRAFT_PART_SRC}/frontend/server/src/main/resources/proto/*.proto ${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper

    override-stage: |
      set -xe
      export PATH=/home/venv/bin:$PATH      
      python3.9 -m venv home/venv

      source home/venv/bin/activate

      python -m pip install -U pip setuptools
      python -m pip install grpcio grpcio-tools

      python ${CRAFT_PART_SRC}/ts_scripts/install_dependencies.py --cuda $CUDA_VERSION
      
      python -m pip install --no-cache-dir torchserve-nightly torch-model-archiver-nightly torch-workflow-archiver-nightly

      python -m grpc_tools.protoc \
        --proto_path=${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper \
        --python_out=${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper \
        --grpc_python_out=${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper \
        ${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper/inference.proto \
        ${CRAFT_PART_INSTALL}/home/model-server/kserve_wrapper/management.proto

    override-prime: |
      cp -rp ${CRAFT_STAGE}/home/venv home/
      cp -rp ${CRAFT_PART_INSTALL}/home/model-server home/

  # not-root user for this rock should be 'model-server'
  non-root-user:
    plugin: nil
    after: [torchserve-kfs]
    overlay-script: |
      # Create a user in the $CRAFT_OVERLAY chroot
      useradd -R $CRAFT_OVERLAY -M -s /bin/bash -N -u 1001 model-server
    override-prime: |
      craftctl default
      chown -R 584792:users home/model-server
      chown -R 584792:users home/venv

     
